[
{
	"uri": "/3-create-api-lambda-function/3-1-create-orders-table-dynamodb-table/",
	"title": "Create OrdersTable DynamoDB table",
	"tags": [],
	"description": "",
	"content": "In this step, we will create a new DynamoDB table using a SAM template.\nCreate FcjOrdersTable DynamoDB table Open template.yaml in the source code you downloaded before.\nAdd the following scripts below to create FcjOrdersTable table.\norderTable: Type: String Default: OrdersTable FcjOrdersTable: Type: AWS::DynamoDB::Table Properties: TableName: !Ref orderTable BillingMode: PAY_PER_REQUEST AttributeDefinitions: - AttributeName: id AttributeType: S - AttributeName: book_id AttributeType: S KeySchema: - AttributeName: id KeyType: HASH - AttributeName: book_id KeyType: RANGE Run the below commands.\nsam build sam validate sam deploy Open AWS DynamoDB console to check. "
},
{
	"uri": "/2-create-sqs-and-sns/2-1-create-sqs/",
	"title": "Create queue",
	"tags": [],
	"description": "",
	"content": " Open Amazon SQS console.\nClick Queues on the left menu. Click Create queue. At Create queue page.\nChoose Standard Type. Enter checkout-queue Name. Leave as default, scroll down and click Create queue button. At checkout-queue page.\nClick Send and receive messages button. At Send and receive messages page.\nEnter The first message at Message body. Click Send message to send message to queue. Click Poll for messages to receive all messages sent to queue. Click to the message that is just shown. At the Message: \u0026hellip; popup, check Body message and click Done button. Click on the checkbox of the message that is just shown. Click Delete button. At the Delete Messages popup, click Delete button. "
},
{
	"uri": "/1-preparation/",
	"title": "Preparation",
	"tags": [],
	"description": "",
	"content": "Before we get to the main content of this workshop, we need to reset the web application.\nDownload the below source code.\nSource code\rfcj-book-store-sam-ws6.zip\r(24397 ko)\rUnzip the source code, open template.yaml.\nChange chaunguyen.site value to your domain name.\nroute53HostedZoneName: Type: String Default: chaunguyen.site Run the below commands. Ensure you have the AWS CLI and SAM CLI installed on your machine, configure AWS credentials before running the commands.\nsam build sam validate sam deploy --guided Enter the following content. Leave as default.\nStack Name []: fcj-book-store AWS Region []: us-east-1 Confirm changes before deploy [Y/n]: y Allow SAM CLI IAM role creation [Y/n]: y Disable rollback [y/N]: n Save arguments to configuration file [Y/n]: y Follow this instruction if your domain registrar isn\u0026rsquo;t AWS. Making Route 53 the DNS service for a domain that\u0026rsquo;s in use\nCopy these NS type records from your Route53 hosted zone. Paste those NS records to your DNS domain registrar. Open template.yaml in the source code you downloaded before.\nUncomment this code block.\n# FcjCertificate: # Type: AWS::CertificateManager::Certificate # Properties: # DomainName: !Sub \u0026#34;*.${route53HostedZoneName}\u0026#34; # SubjectAlternativeNames: # - !Ref route53HostedZoneName # ValidationMethod: DNS # DomainValidationOptions: # - DomainName: !Sub \u0026#34;*.${route53HostedZoneName}\u0026#34; # HostedZoneId: !Ref FcjRoute53HostedZone # FcjCloudFrontDistribution: # Type: AWS::CloudFront::Distribution # Properties: # DistributionConfig: # Enabled: true # Origins: # - DomainName: !GetAtt FcjBookShop.RegionalDomainName # Id: !Ref FcjBookShop # CustomOriginConfig: # HTTPPort: 80 # HTTPSPort: 443 # OriginProtocolPolicy: match-viewer # OriginSSLProtocols: # - TLSv1 # - TLSv1.1 # - TLSv1.2 # Aliases: # - !Sub \u0026#34;www.${route53HostedZoneName}\u0026#34; # - !Ref route53HostedZoneName # DefaultCacheBehavior: # CachePolicyId: !Ref cachePolicyId # ViewerProtocolPolicy: redirect-to-https # TargetOriginId: !Ref FcjBookShop # AllowedMethods: # - GET # - HEAD # DefaultRootObject: index.html # ViewerCertificate: # AcmCertificateArn: !Ref FcjCertificate # SslSupportMethod: sni-only # FcjRoute53RecordSet: # Type: AWS::Route53::RecordSet # Properties: # HostedZoneId: !Ref FcjRoute53HostedZone # Name: !Sub \u0026#34;www.${route53HostedZoneName}.\u0026#34; # Type: A # AliasTarget: # DNSName: !GetAtt FcjCloudFrontDistribution.DomainName # HostedZoneId: !Ref cloudFrontHostedZoneId Run the below commands.\nCloudfront Distribution can take a while to complete, so please be patient.\nsam build sam validate sam deploy Download the FCJ-Serverless-Workshop code to your device.\nOpen a terminal on your computer in the folder where you want to save the source code.\nCopy the below command.\ngit clone https://github.com/AWS-First-Cloud-Journey/FCJ-Serverless-Workshop.git cd FCJ-Serverless-Workshop Open FCJ-Serverless-Workshop with VSCode and edit.\nOpen src/App.js and edit isAdmin: true as below. Back to FCJ-Serverless-Workshop root path and run the commands below.\nyarn yarn build We have finished building the front-end. Next execute the following command to upload the build folder to S3.\naws s3 cp build s3://fcj-book-shop-by-myself --recursive Enter the following links in a new tab in your web browser: http://www.DOMAIN, replace all DOMAIN with your domain name. All those links redirect to the new path, replace http with https. So we have rebuilt the web application.\n"
},
{
	"uri": "/",
	"title": "Serverless - Processing orders with SQS and SNS",
	"tags": [],
	"description": "",
	"content": "Serverless - Processing orders with SQS and SNS Overview In the workshop 6 of this series, we will process user orders using Amazon SQS and SNS. When user places an order, the order will be send to the queue and SNS will notify the admin about about the new order. Admin has the right to view all orders and process or delete them.\nThe architecture of the web application: When user places an order (click Checkout), the POST API /books/order puts the order\u0026rsquo;s information into a queue you create, then pulish a message via Amazon SNS topic GET API /books/order is called when admin uses order management to get all pending and processed orders in DynamoDB table When the Admin processes the order (click Handle), the POST API /books/order/handle will write the order to DynamoDB and remove it from the queue When Admin deletes an order (press Delete), DELETE API /books/order will remove the order from the queue Amazon Simple Queue Service Amazon Simple Queue Service (Amazon SQS) offers a secure, durable, and available hosted queue that lets you integrate and decouple distributed software systems and components. It can scale independently from our application. It provides a generic web services API that you can access using any programming language that the AWS SDK supports.\nThere are three main parts in a distributed messaging system: the components of your distributed system, your queue (distributed on Amazon SQS servers), and the messages in the queue. Example: your system has several producers (components that send messages to the queue) and consumers (components that receive messages from the queue). The queue (which holds messages) stores the messages on Amazon SQS servers.\nAmazon Simple Notification Service Amazon Simple Notification Service (Amazon SNS) is a managed service that provides message delivery from publishers to subscribers (also known as producers and consumers). Publishers communicate asynchronously with subscribers by sending messages to a topic, which is a logical access point and communication channel. Clients can subscribe to the SNS topic and receive published messages using a supported endpoint type, such as Amazon Kinesis Data Firehose, Amazon SQS, AWS Lambda, HTTP, email, mobile push notifications, and mobile text messages (SMS).\nContent Preparation Create queue and SNS topic Create API and Lambda function Test web operation Cleanup "
},
{
	"uri": "/3-create-api-lambda-function/3-2-create-checkout-order-lambda-function/",
	"title": "Create checkout_order Lambda function",
	"tags": [],
	"description": "",
	"content": "In this step, we will create a new checkout_order Lambda function using a SAM template.\nPreparation Open template.yaml in the source code you downloaded before.\nComment this code block.\n# BookApiDeployment: # Type: AWS::ApiGateway::Deployment # Properties: # RestApiId: !Ref BookApi # DependsOn: # - BookApiGet # - BookApiCreate # - BookApiDelete # - LoginApi # - RegisterApi # - ConfirmApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage # DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Create FcjCheckOutOrder function Open template.yaml in the source code you downloaded before.\nAdd the following scripts below to create FcjCheckOutOrder function. Change checkoutQueueUrl and orderTopicArn value to your value.\ncheckoutQueueName: Type: String Default: checkout-queue checkoutQueueUrl: Type: String Default: https://sqs.us-east-1.amazonaws.com/017820706022/checkout-queue orderTopicName: Type: String Default: order-notice orderTopicArn: Type: String Default: arn:aws:sns:us-east-1:017820706022:order-notice checkoutPathPart: Type: String Default: order FcjCheckOutOrderFunction: Type: AWS::Serverless::Function Properties: CodeUri: fcj-book-shop/checkout_order Handler: checkout_order.lambda_handler Runtime: python3.11 FunctionName: checkout_order Environment: Variables: SQS_QUEUE_URL: !Ref checkoutQueueUrl SNS_TOPIC_ARN: !Ref orderTopicArn Architectures: - x86_64 Policies: - Statement: - Sid: VisualEditor0 Effect: Allow Action: - sqs:* Resource: - !Sub \u0026#34;arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${checkoutQueueName}\u0026#34; - Sid: VisualEditor1 Effect: Allow Action: - sns:Publish Resource: - !Sub \u0026#34;arn:aws:sns:${AWS::Region}:${AWS::AccountId}:${orderTopicName}\u0026#34; FcjCheckoutOrderResource: Type: AWS::ApiGateway::Resource Properties: RestApiId: !Ref BookApi ParentId: !Ref BookApiResource PathPart: !Ref checkoutPathPart FcjCheckoutOrderApiOptions: Type: AWS::ApiGateway::Method Properties: HttpMethod: OPTIONS RestApiId: !Ref BookApi ResourceId: !Ref FcjCheckoutOrderResource AuthorizationType: NONE Integration: Type: MOCK RequestTemplates: application/json: \u0026#39;{\u0026#34;statusCode\u0026#34;: 200}\u0026#39; IntegrationResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: \u0026#34;\u0026#39;*\u0026#39;\u0026#34; method.response.header.Access-Control-Allow-Methods: \u0026#34;\u0026#39;OPTIONS,POST,GET,DELETE\u0026#39;\u0026#34; method.response.header.Access-Control-Allow-Headers: \u0026#34;\u0026#39;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token\u0026#39;\u0026#34; MethodResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: true method.response.header.Access-Control-Allow-Methods: true method.response.header.Access-Control-Allow-Headers: true FcjCheckoutOrderApi: Type: AWS::ApiGateway::Method Properties: HttpMethod: POST RestApiId: !Ref BookApi ResourceId: !Ref FcjCheckoutOrderResource AuthorizationType: NONE Integration: Type: AWS_PROXY IntegrationHttpMethod: POST # For Lambda integrations, you must set the integration method to POST Uri: !Sub \u0026gt;- arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FcjCheckOutOrderFunction.Arn}/invocations MethodResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: true method.response.header.Access-Control-Allow-Methods: true method.response.header.Access-Control-Allow-Headers: true FcjCheckoutOrderApiInvokePermission: Type: AWS::Lambda::Permission Properties: FunctionName: !Ref FcjCheckOutOrderFunction Action: lambda:InvokeFunction Principal: apigateway.amazonaws.com SourceAccount: !Ref \u0026#34;AWS::AccountId\u0026#34; The directory structure is as follows.\nfcj-book-shop-sam-ws3 ├── fcj-book-shop │ ├── checkout_order │ │ └── checkout_order.py │ ├── ... │ └── template.yaml Create checkout_order folder in fcj-book-shop-sam-ws6/fcj-book-shop/ folder.\nCreate checkout_order.py file and copy the following code to it.\nimport json import boto3 import os headers = { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;Access-Control-Allow-Origin\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Access-Control-Allow-Methods\u0026#34;: \u0026#34;OPTIONS,POST,GET,DELETE\u0026#34;, \u0026#34;Access-Control-Allow-Headers\u0026#34;: \u0026#34;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token\u0026#34; } def lambda_handler(event, context): sqs = boto3.client(\u0026#39;sqs\u0026#39;) sns = boto3.client(\u0026#39;sns\u0026#39;) sqs_queue_url = os.environ[\u0026#39;SQS_QUEUE_URL\u0026#39;] sns_topic_arn = os.environ[\u0026#39;SNS_TOPIC_ARN\u0026#39;] sns_topic_subject = \u0026#34;New order received. Please process.\u0026#34; try: body = json.loads(event[\u0026#39;body\u0026#39;]) print(f\u0026#34;body: {body}\u0026#34;) # Send to SQS sqs_response = sqs.send_message( QueueUrl=sqs_queue_url, MessageBody=json.dumps(body) ) # Send to SNS sns_response = sns.publish( TopicArn=sns_topic_arn, Message=f\u0026#34;New order received: {json.dumps(body)}\u0026#34;, Subject=sns_topic_subject ) return { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;headers\u0026#39;: headers, \u0026#39;body\u0026#39;: json.dumps({ \u0026#39;message\u0026#39;: \u0026#39;Order processed successfully\u0026#39;, \u0026#39;sqs_message_id\u0026#39;: sqs_response[\u0026#39;MessageId\u0026#39;], \u0026#39;sns_message_id\u0026#39;: sns_response[\u0026#39;MessageId\u0026#39;] }) } except Exception as e: print(f\u0026#34;Error processing order: {e}\u0026#34;) raise Exception(f\u0026#34;Error processing order: {e}\u0026#34;) Uncomment this code block.\nBookApiDeployment: Type: AWS::ApiGateway::Deployment Properties: RestApiId: !Ref BookApi DependsOn: - BookApiGet - BookApiCreate - BookApiDelete - LoginApi - RegisterApi - ConfirmApi - FcjCheckoutOrderApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Check the creation Open Amazon API Gateway console.\nClick fcj-serverless-api. Click Resources on the left menu. Check /order just created. Open Amazon Lambda console.\nClick Functions on the left menu. Choose checkout_order function. At checkout_order page, check the function that just created. "
},
{
	"uri": "/2-create-sqs-and-sns/",
	"title": "Create queue and SNS topic",
	"tags": [],
	"description": "",
	"content": "In this step, we will create a queue with Amazon SQS and an SNS topic with Amazon SNS.\nCreate SQS Create SNS topic "
},
{
	"uri": "/2-create-sqs-and-sns/2-2-create-sns/",
	"title": "Create SNS topic",
	"tags": [],
	"description": "",
	"content": " Open Amazon SNS console\nClick Topics on the left menu. Click Create topic button. At Create topic page.\nClick Standard at Type. Enter order-notice at Name. Leave as default, scroll down and click Create topic button. At order-notice page.\nClick Subscriptions tab. Click Create subscription button. At Create subscription page.\nChoose Email at Protocol. Enter your email at Endpoint. Click Create subscription. Back to order-notice page.\nClick Subscriptions tab. Check the subscription that is just created with Pending confirmation status. Open your email box, search mail sent from no-reply@sns.amazonaws.com.\nClick on Confirm subscription link. It will direct you to a new tab. Back to order-notice page, check the status Confirmed of the subscription that you just created. "
},
{
	"uri": "/3-create-api-lambda-function/",
	"title": "Create API and Lambda function",
	"tags": [],
	"description": "",
	"content": "After creating the queue and SQS topic, we will create the APIs and Lambda functions to interact with the queue and SQS topic.\nCreate OrdersTable DynamoDB table Create checkout_order Lambda function Create order_management Lambda function Create handle_order Lambda function Create delete_order Lambda function "
},
{
	"uri": "/3-create-api-lambda-function/3-3-create-order-management-lambda-function/",
	"title": "Create order_management Lambda function",
	"tags": [],
	"description": "",
	"content": "In this step, we will create a new order_management Lambda function using a SAM template.\nPreparation Open template.yaml in the source code you downloaded before.\nComment this code block.\n# BookApiDeployment: # Type: AWS::ApiGateway::Deployment # Properties: # RestApiId: !Ref BookApi # DependsOn: # - BookApiGet # - BookApiCreate # - BookApiDelete # - LoginApi # - RegisterApi # - ConfirmApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage # DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Create FcjOrderManagement function Open template.yaml in the source code you downloaded before.\nAdd the following scripts below to create FcjOrderManagement function.\nFcjOrderManagementFunction: Type: AWS::Serverless::Function Properties: CodeUri: fcj-book-shop/order_management Handler: order_management.lambda_handler Runtime: python3.11 FunctionName: order_management Environment: Variables: SQS_QUEUE_URL: !Ref checkoutQueueUrl ORDER_TABLE_NAME: !Ref orderTable Architectures: - x86_64 Policies: - Statement: - Sid: VisualEditor0 Effect: Allow Action: - dynamodb:Scan - dynamodb:Query Resource: - !Sub \u0026#34;arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${orderTable}\u0026#34; - Sid: VisualEditor1 Effect: Allow Action: - sqs:* Resource: - !Sub \u0026#34;arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${checkoutQueueName}\u0026#34; FcjOrderManagementApi: Type: AWS::ApiGateway::Method Properties: HttpMethod: GET RestApiId: !Ref BookApi ResourceId: !Ref FcjCheckoutOrderResource AuthorizationType: NONE Integration: Type: AWS_PROXY IntegrationHttpMethod: POST # For Lambda integrations, you must set the integration method to POST Uri: !Sub \u0026gt;- arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FcjOrderManagementFunction.Arn}/invocations MethodResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: true method.response.header.Access-Control-Allow-Methods: true method.response.header.Access-Control-Allow-Headers: true FcjOrderManagementApiInvokePermission: Type: AWS::Lambda::Permission Properties: FunctionName: !Ref FcjOrderManagementFunction Action: lambda:InvokeFunction Principal: apigateway.amazonaws.com SourceAccount: !Ref \u0026#34;AWS::AccountId\u0026#34; The directory structure is as follows.\nfcj-book-shop-sam-ws3 ├── fcj-book-shop │ ├── checkout_order │ │ └── checkout_order.py │ ├── order_management │ │ └── order_management.py │ ├── ... │ └── template.yaml Create order_management folder in fcj-book-shop-sam-ws6/fcj-book-shop/ folder.\nCreate order_management.py file and copy the following code to it.\nimport os import json import boto3 headers = { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;Access-Control-Allow-Origin\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Access-Control-Allow-Methods\u0026#34;: \u0026#34;OPTIONS,POST,GET,DELETE\u0026#34;, \u0026#34;Access-Control-Allow-Headers\u0026#34;: \u0026#34;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token\u0026#34; } dynamodb = boto3.resource(\u0026#39;dynamodb\u0026#39;) sqs = boto3.client(\u0026#39;sqs\u0026#39;) # Get value of the environment variables table_name = os.getenv(\u0026#39;ORDER_TABLE_NAME\u0026#39;) queue_url = os.getenv(\u0026#39;SQS_QUEUE_URL\u0026#39;) def get_messages_from_sqs(messages): # Get the total number of messages in the queue response = sqs.get_queue_attributes( QueueUrl=queue_url, AttributeNames=[\u0026#39;ApproximateNumberOfMessages\u0026#39;] ) total_messages = int(response[\u0026#39;Attributes\u0026#39;][\u0026#39;ApproximateNumberOfMessages\u0026#39;]) while len(messages) \u0026lt; total_messages: # Receive messages from SQS queue received_message_res = sqs.receive_message( QueueUrl=queue_url, MaxNumberOfMessages=10, WaitTimeSeconds=20 ) if \u0026#39;Messages\u0026#39; in received_message_res: for message in received_message_res[\u0026#39;Messages\u0026#39;]: messages.append({ \u0026#34;receiptHandle\u0026#34;: message[\u0026#34;ReceiptHandle\u0026#34;], \u0026#34;books\u0026#34;: json.loads(message[\u0026#34;Body\u0026#34;])[\u0026#39;books\u0026#39;], \u0026#34;price\u0026#34;: json.loads(message[\u0026#34;Body\u0026#34;])[\u0026#39;price\u0026#39;], \u0026#34;status\u0026#34;: \u0026#34;Unprocessed\u0026#34; }) def get_messages_from_dynamodb(messages): table = dynamodb.Table(table_name) try: res = table.scan() orders = res.get(\u0026#39;Items\u0026#39;, []) aggregated_orders = {} for order in orders: order_id = order[\u0026#39;id\u0026#39;] book = { \u0026#39;id\u0026#39;: order[\u0026#39;book_id\u0026#39;], \u0026#39;name\u0026#39;: order[\u0026#39;name\u0026#39;], \u0026#39;qty\u0026#39;: order[\u0026#39;qty\u0026#39;], } if order_id not in aggregated_orders: aggregated_orders[order_id] = { \u0026#39;id\u0026#39;: order_id, \u0026#39;books\u0026#39;: [book], \u0026#39;price\u0026#39;: order[\u0026#39;price\u0026#39;] } else: aggregated_orders[order_id][\u0026#39;books\u0026#39;].append(book) for order in aggregated_orders.values(): messages.append({ \u0026#34;receiptHandle\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;books\u0026#34;: order[\u0026#39;books\u0026#39;], \u0026#34;price\u0026#34;: order[\u0026#39;price\u0026#39;], \u0026#34;status\u0026#34;: \u0026#34;Processed\u0026#34; }) except Exception as e: print(f\u0026#34;Error reading from DynamoDB: {e}\u0026#34;) raise Exception(f\u0026#34;Error reading from DynamoDB: {e}\u0026#34;) def lambda_handler(event, context): messages = [] # Get messages from sqs get_messages_from_sqs(messages) # Get Messages from DynamoDB get_messages_from_dynamodb(messages) return { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;body\u0026#39;: json.dumps(messages), \u0026#39;headers\u0026#39;: headers } Uncomment this code block.\nBookApiDeployment: Type: AWS::ApiGateway::Deployment Properties: RestApiId: !Ref BookApi DependsOn: - BookApiGet - BookApiCreate - BookApiDelete - LoginApi - RegisterApi - ConfirmApi - FcjCheckoutOrderApi - FcjOrderManagementApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Check the creation Open Amazon API Gateway console.\nClick fcj-serverless-api. Click Resources on the left menu. Check /order just created. Open Amazon Lambda console.\nClick Functions on the left menu. Choose order_management function. At order_management page, check the function that just created. "
},
{
	"uri": "/3-create-api-lambda-function/3-4-create-handle-order-lambda-function/",
	"title": "Create handle_order Lambda function",
	"tags": [],
	"description": "",
	"content": "In this step, we will create a new handle_order Lambda function using a SAM template.\nPreparation Open template.yaml in the source code you downloaded before.\nComment this code block.\n# BookApiDeployment: # Type: AWS::ApiGateway::Deployment # Properties: # RestApiId: !Ref BookApi # DependsOn: # - BookApiGet # - BookApiCreate # - BookApiDelete # - LoginApi # - RegisterApi # - ConfirmApi # - FcjCheckoutOrderApi # - FcjOrderManagementApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage # DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Create FcjHandleOrder function Open template.yaml in the source code you downloaded before.\nAdd the following scripts below to create FcjHandleOrder function.\nhandleOrderPathPart: Type: String Default: handle FcjHandleOrderResource: Type: AWS::ApiGateway::Resource Properties: RestApiId: !Ref BookApi ParentId: !Ref FcjCheckoutOrderResource PathPart: !Ref handleOrderPathPart FcjHandleOrderFunction: Type: AWS::Serverless::Function Properties: CodeUri: fcj-book-shop/handle_order Handler: handle_order.lambda_handler Runtime: python3.11 FunctionName: handle_order Environment: Variables: ORDER_TABLE_NAME: !Ref orderTable SQS_QUEUE_URL: !Ref checkoutQueueUrl Architectures: - x86_64 Policies: - Statement: - Sid: VisualEditor0 Effect: Allow Action: - dynamodb:PutItem - dynamodb:BatchWriteItem Resource: - !Sub \u0026#34;arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${orderTable}\u0026#34; - Sid: VisualEditor1 Effect: Allow Action: - sqs:* Resource: - !Sub \u0026#34;arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${checkoutQueueName}\u0026#34; FcjHandleOrderApiOptions: Type: AWS::ApiGateway::Method Properties: HttpMethod: OPTIONS RestApiId: !Ref BookApi ResourceId: !Ref FcjHandleOrderResource AuthorizationType: NONE Integration: Type: MOCK IntegrationResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: \u0026#34;\u0026#39;*\u0026#39;\u0026#34; method.response.header.Access-Control-Allow-Methods: \u0026#34;\u0026#39;OPTIONS,POST,GET,DELETE\u0026#39;\u0026#34; method.response.header.Access-Control-Allow-Headers: \u0026#34;\u0026#39;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token\u0026#39;\u0026#34; MethodResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: true method.response.header.Access-Control-Allow-Methods: true method.response.header.Access-Control-Allow-Headers: true FcjHandleOrderApi: Type: AWS::ApiGateway::Method Properties: HttpMethod: POST RestApiId: !Ref BookApi ResourceId: !Ref FcjHandleOrderResource AuthorizationType: NONE Integration: Type: AWS_PROXY IntegrationHttpMethod: POST # For Lambda integrations, you must set the integration method to POST Uri: !Sub \u0026gt;- arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FcjHandleOrderFunction.Arn}/invocations MethodResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: true method.response.header.Access-Control-Allow-Methods: true method.response.header.Access-Control-Allow-Headers: true FcjHandleOrderApiInvokePermission: Type: AWS::Lambda::Permission Properties: FunctionName: !Ref FcjHandleOrderFunction Action: lambda:InvokeFunction Principal: apigateway.amazonaws.com SourceAccount: !Ref \u0026#34;AWS::AccountId\u0026#34; The directory structure is as follows.\nfcj-book-shop-sam-ws3 ├── fcj-book-shop │ ├── checkout_order │ │ └── checkout_order.py │ ├── order_management │ │ └── order_management.py │ ├── handle_order │ │ └── handle_order.py │ ├── ... │ └── template.yaml Create handle_order folder in fcj-book-shop-sam-ws6/fcj-book-shop/ folder.\nCreate handle_order.py file and copy the following code to it.\nimport json import boto3 import os headers = { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;Access-Control-Allow-Origin\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Access-Control-Allow-Methods\u0026#34;: \u0026#34;OPTIONS,POST,GET,DELETE\u0026#34;, \u0026#34;Access-Control-Allow-Headers\u0026#34;: \u0026#34;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token\u0026#34; } dynamodb = boto3.resource(\u0026#39;dynamodb\u0026#39;) sqs = boto3.client(\u0026#39;sqs\u0026#39;) # Define the DynamoDB table name and SQS queue URL table_name = os.getenv(\u0026#39;ORDER_TABLE_NAME\u0026#39;) queue_url = os.getenv(\u0026#39;SQS_QUEUE_URL\u0026#39;) def lambda_handler(event, context): # Get product body info from the event products = json.loads(event[\u0026#39;body\u0026#39;]) books = products[\u0026#39;books\u0026#39;] receipt_handle = products[\u0026#39;receiptHandle\u0026#39;] # Write product info to DynamoDB table = dynamodb.Table(table_name) try: for book in books: data = { \u0026#39;id\u0026#39;: products[\u0026#39;id\u0026#39;], \u0026#39;book_id\u0026#39;: book[\u0026#39;id\u0026#39;], \u0026#39;name\u0026#39;: book[\u0026#39;name\u0026#39;], \u0026#39;qty\u0026#39;: book[\u0026#39;qty\u0026#39;], \u0026#39;price\u0026#39;: str(products[\u0026#39;price\u0026#39;]) } table.put_item(Item=data) except Exception as e: print(f\u0026#34;Error writing to DynamoDB: {e}\u0026#34;) raise Exception(f\u0026#34;Error writing to DynamoDB: {e}\u0026#34;) # Delete message in SQS try: sqs.delete_message( QueueUrl=queue_url, ReceiptHandle=receipt_handle ) except Exception as e: print(f\u0026#34;Error deleting message from SQS: {e}\u0026#34;) raise Exception(f\u0026#34;Error deleting message from SQS: {e}\u0026#34;) return { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;headers\u0026#39;: headers, \u0026#39;body\u0026#39;: json.dumps(\u0026#39;Order processed successfully\u0026#39;) } Uncomment this code block.\nBookApiDeployment: Type: AWS::ApiGateway::Deployment Properties: RestApiId: !Ref BookApi DependsOn: - BookApiGet - BookApiCreate - BookApiDelete - LoginApi - RegisterApi - ConfirmApi - FcjCheckoutOrderApi - FcjOrderManagementApi - FcjHandleOrderApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Check the creation Open Amazon API Gateway console.\nClick fcj-serverless-api. Click Resources on the left menu. Check /handle just created. Open Amazon Lambda console.\nClick Functions on the left menu. Choose handle_order function. At handle_order page, check the function that just created. "
},
{
	"uri": "/4-test-operation/",
	"title": "Test web operation",
	"tags": [],
	"description": "",
	"content": "In this step, we will test Web operation.\nOpen API Gateway console.\nClick APIs on the left menu. Choose fcj-serverless-api. Click Stages on the left menu. Choose Staging. Record Invoke URL. Open config.js file in source code folder of application - FCJ-Serverless-Workshop.\nReplace APP_API_URL with InvokeURL. Open your terminal and run the below commands.\nyarn build aws s3 rm s3://fcj-book-shop-by-myself --recursive aws s3 cp build s3://fcj-book-shop-by-myself --recursive You can download the image files here to add data to check the operation of the services. Images\rJava.jpg\r(23 ko)\rLetGoBook.png\r(292 ko)\rEnter the following links in a new tab in your web browser: http://www.DOMAIN, replace all DOMAIN with your domain name. All those links redirect to the new path, replace http with https. Click Create new book.\nEnter ID: 1. Enter book name: Java. Enter author: Jame Patterson. Enter category: IT. Enter price: 10.98. Enter description: A beginner's guide to learning the basic of Java. Click Choose File button và choose **LetGoBook.png`` image that you just downloaded. Click Create button. Click OK button when popup opens. Create the new book as the previous step.\nClick Create new book. Enter ID: 2. Enter book name: Let's Go. Enter author: Alex Edwards. Enter category: IT. Enter price: 15.8. Enter description: A step-by-step guide to creating fast, secure web with Go. Click Choose File button và choose **LetGoBook.png`` image that you just downloaded. Click Create button. Click OK button when popup opens. Back to Homepage.\nClick Home. Click Add to cart button to add both 2 books to the cart. Then, click on Cart icon in the upper right corner. At Cart Items page.\nClick Checkout button. Then, click OK button. Open Amazon SQS console.\nClick Queues on the left menu. Click checkout-queue queue. At checkout-queue page, click Send and receive messages button. At Send and receive messages page, click Poll for messages button. Then, click on the showing message. Check the Message: \u0026hellip; popup and click Done button. Open the email that you have subscribed to receive the notification. Back to the application tab.\nClick Orders and check the books you added to the cart. Next, repeat the 5th step to add some more orders as you want.\nOpen the application tab.\nClick Orders and check the books you added to the cart. Click Handle button and then click OK button on the popup. Open AWS DynamoDB.\nClick Tables on the left menu. Choose OrdersTable table. At OrdersTable page, click Explore table items button. You could see the two books in the order that you clicked the Handle button before. Back to the application tab.\nClick Orders and check the books you added to the cart. Next, click Delete button and then click OK button on the popup. The deleted item are no longer displayed. "
},
{
	"uri": "/5-cleanup/",
	"title": "Clean up",
	"tags": [],
	"description": "",
	"content": "\rIt will take a bit time to finish the cleanup\nCleanup the Route 53\nOpen AWS Route 53 console. Click Hosted zones on the left menu. Choose your Hosted zones and cleanup all the records if possible. Empty S3 bucket.\nOpen AWS S3 console. Select fcj-book-shop-by-myself. Click Empty. Enter permanently delete. Click Empty. Do the same for bucket starting with aws-sam-cli-managed-default- and book-image-resize-shop-by-myself. Delete CloudFormation stacks.\nExecute the below command to delete the AWS SAM application.\nsam delete --stack-name fcj-book-store sam delete --stack-name aws-sam-cli-managed-default If you have issues when deleting with command. Open AWS Cloudformation console. Then, delete all stacks related to this workshop.\nCleanup SQS.\nOpen Amazon SQS console. Choose checkout-queue. Click Delete. Enter confirm. Click Delete. Cleanup SNS.\nOpen Amazon SNS console. Choose order-notice at Topics. Click Delete. Enter delete me. Click Delete. "
},
{
	"uri": "/3-create-api-lambda-function/3-5-create-delete-order-lambda-function/",
	"title": "Create delete_order Lambda function",
	"tags": [],
	"description": "",
	"content": "In this step, we will create a new delete_order Lambda function using a SAM template.\nPreparation Open template.yaml in the source code you downloaded before.\nComment this code block.\n# BookApiDeployment: # Type: AWS::ApiGateway::Deployment # Properties: # RestApiId: !Ref BookApi # DependsOn: # - BookApiGet # - BookApiCreate # - BookApiDelete # - LoginApi # - RegisterApi # - ConfirmApi # - FcjCheckoutOrderApi # - FcjOrderManagementApi # - FcjHandleOrderApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage # DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Create FcjDeleteOrder function Open template.yaml in the source code you downloaded before.\nAdd the following scripts below to create FcjDeleteOrder function.\nFcjDeleteOrderFunction: Type: AWS::Serverless::Function Properties: CodeUri: fcj-book-shop/delete_order Handler: delete_order.lambda_handler Runtime: python3.11 FunctionName: delete_order Environment: Variables: SQS_QUEUE_URL: !Ref checkoutQueueUrl Architectures: - x86_64 Policies: - Statement: - Sid: VisualEditor0 Effect: Allow Action: - sqs:* Resource: - !Sub \u0026#34;arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${checkoutQueueName}\u0026#34; FcjDeleteOrderApi: Type: AWS::ApiGateway::Method Properties: HttpMethod: DELETE RestApiId: !Ref BookApi ResourceId: !Ref FcjCheckoutOrderResource AuthorizationType: NONE Integration: Type: AWS_PROXY IntegrationHttpMethod: POST # For Lambda integrations, you must set the integration method to POST Uri: !Sub \u0026gt;- arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FcjDeleteOrderFunction.Arn}/invocations MethodResponses: - StatusCode: \u0026#34;200\u0026#34; ResponseParameters: method.response.header.Access-Control-Allow-Origin: true method.response.header.Access-Control-Allow-Methods: true method.response.header.Access-Control-Allow-Headers: true FcjDeleteOrderApiInvokePermission: Type: AWS::Lambda::Permission Properties: FunctionName: !Ref FcjDeleteOrderFunction Action: lambda:InvokeFunction Principal: apigateway.amazonaws.com SourceAccount: !Ref \u0026#34;AWS::AccountId\u0026#34; The directory structure is as follows.\nfcj-book-shop-sam-ws3 ├── fcj-book-shop │ ├── checkout_order │ │ └── checkout_order.py │ ├── order_management │ │ └── order_management.py │ ├── handle_order │ │ └── handle_order.py │ ├── delete_order │ │ └── delete_order.py │ ├── ... │ └── template.yaml Create delete_order folder in fcj-book-shop-sam-ws6/fcj-book-shop/ folder.\nCreate delete_order.py file and copy the following code to it.\nimport json import boto3 import os headers = { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;Access-Control-Allow-Origin\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Access-Control-Allow-Methods\u0026#34;: \u0026#34;OPTIONS,POST,GET,DELETE\u0026#34;, \u0026#34;Access-Control-Allow-Headers\u0026#34;: \u0026#34;Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token\u0026#34; } sqs = boto3.client(\u0026#39;sqs\u0026#39;) # Get value of the environment variables queue_url = os.getenv(\u0026#39;SQS_QUEUE_URL\u0026#39;) def lambda_handler(event, context): order = json.loads(event[\u0026#39;body\u0026#39;]) try: if \u0026#39;receiptHandle\u0026#39; in order and order[\u0026#39;receiptHandle\u0026#39;]: sqs.delete_message( QueueUrl=queue_url, ReceiptHandle=order[\u0026#39;receiptHandle\u0026#39;] ) else: raise Exception(\u0026#34;No receiptHandle provided\u0026#34;) except Exception as e: print(f\u0026#34;Error deleting order: {e}\u0026#34;) raise Exception(f\u0026#34;Error deleting order: {e}\u0026#34;) return { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;headers\u0026#39;: headers, \u0026#39;body\u0026#39;: json.dumps(\u0026#39;Order deleted successfully\u0026#39;) } Uncomment this code block.\nBookApiDeployment: Type: AWS::ApiGateway::Deployment Properties: RestApiId: !Ref BookApi DependsOn: - BookApiGet - BookApiCreate - BookApiDelete - LoginApi - RegisterApi - ConfirmApi - FcjCheckoutOrderApi - FcjOrderManagementApi - FcjHandleOrderApi - FcjDeleteOrderApi BookApiStage: Type: AWS::ApiGateway::Stage Properties: RestApiId: !Ref BookApi StageName: !Ref stage DeploymentId: !Ref BookApiDeployment Run the below commands.\nsam build sam validate sam deploy Check the creation Open Amazon API Gateway console.\nClick fcj-serverless-api. Click Resources on the left menu. Check /order just created. Open Amazon Lambda console.\nClick Functions on the left menu. Choose delete_order function. At delete_order page, check the function that just created. "
},
{
	"uri": "/categories/",
	"title": "Categories",
	"tags": [],
	"description": "",
	"content": ""
},
{
	"uri": "/tags/",
	"title": "Tags",
	"tags": [],
	"description": "",
	"content": ""
}]